# ==========================================
# Perfil de producción
# ==========================================

# Seguridad habilitada por defecto en producción
apigen:
  security:
    enabled: true

spring:
  # Base de datos PostgreSQL (producción)
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      # Pool optimizado para Virtual Threads (Java 21+) en producción
      # Con virtual threads, se pueden manejar más conexiones concurrentes
      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:250}
      minimum-idle: ${HIKARI_MIN_IDLE:50}
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-test-query: SELECT 1
      # Nombre del pool para métricas
      pool-name: APiGen-HikariPool-Prod
      # Métricas de conexiones
      register-mbeans: true
      # Leak detection (opcional, útil para debugging)
      leak-detection-threshold: ${HIKARI_LEAK_DETECTION:0}

  # JPA / Hibernate (producción)
  jpa:
    hibernate:
      ddl-auto: none # NUNCA auto-actualizar esquema en producción
    show-sql: false # No mostrar SQL en logs de producción
    properties:
      hibernate:
        format_sql: false
        use_sql_comments: false
        generate_statistics: false
        # Optimizaciones de rendimiento
        jdbc:
          batch_size: 50
          fetch_size: 100
        order_inserts: true
        order_updates: true
    open-in-view: false

  # Flyway migrations
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true

# Actuator endpoints (restringido en producción)
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized # Solo para usuarios autorizados
    caches:
      enabled: false # Deshabilitado en producción
  # Endpoint para el colector OpenTelemetry (debe ser proveído en producción)
  otlp:
    tracing:
      endpoint: ${OTLP_ENDPOINT}

# CORS estricto para producción
app:
  cors:
    # IMPORTANTE: Configurar con los dominios reales de producción
    allowed-origins: ${CORS_ALLOWED_ORIGINS:https://tu-dominio.com}
    allow-credentials: true
    max-age: 7200

  # Caché optimizada para producción (valores configurables via env vars)
  cache:
    entities:
      max-size: ${CACHE_ENTITIES_MAX_SIZE:50000}
      expire-after-write: ${CACHE_ENTITIES_TTL:30m}
    lists:
      max-size: ${CACHE_LISTS_MAX_SIZE:5000}
      expire-after-write: ${CACHE_LISTS_TTL:15m}
    counts:
      max-size: ${CACHE_COUNTS_MAX_SIZE:1000}
      expire-after-write: ${CACHE_COUNTS_TTL:5m}

# Logging mínimo en producción
logging:
  level:
    root: WARN
    com.jnzader.apigen: INFO
    org.springframework.security: WARN
    org.hibernate.SQL: WARN
  file:
    name: /var/log/apigen/application.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30

# Server configuration
server:
  port: ${PORT:8080}
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
    min-response-size: 1024
  http2:
    enabled: true
  error:
    include-stacktrace: never # NUNCA mostrar stacktrace en producción
    include-message: never
