spring:
  application:
    name: apigen
  # Virtual threads (Java 21+)
  threads:
    virtual:
      enabled: true

# Configuración de seguridad APiGen
# La habilitación se gestiona por perfil (p.ej., application-dev.yaml)
apigen:
  security:
    jwt:
      # REQUERIDO cuando la seguridad está habilitada en un perfil.
      # Generar con: openssl rand -base64 64
      secret: ${JWT_SECRET:}
      expiration-minutes: ${JWT_EXPIRATION_MINUTES:15}
      refresh-expiration-minutes: ${JWT_REFRESH_EXPIRATION_MINUTES:10080}
      issuer: ${JWT_ISSUER:apigen}

# Configuración de la aplicación
app:
  # Versionado de API
  api:
    version: v1
    base-path: /api

  # Métricas
  metrics:
    enabled: true
    slow-threshold-ms: 500

  # Configuración CORS (orígenes permitidos se definen por perfil)
  cors:
    allowed-methods: GET,POST,PUT,PATCH,DELETE,OPTIONS
    allowed-headers: Authorization,Content-Type,X-Requested-With,Accept,Origin,X-XSRF-TOKEN
    exposed-headers: Authorization,X-Total-Count,X-Page-Number,X-Page-Size
    allow-credentials: true
    max-age: 3600

  # Configuración de seguridad
  security:
    public-endpoints: /api/*/public/**,/swagger-ui/**,/v3/api-docs/**,/actuator/health,/actuator/info
    # Rate limiting específico para endpoints de autenticación
    auth-rate-limit:
      max-attempts: ${AUTH_RATE_LIMIT_MAX_ATTEMPTS:5}
      lockout-minutes: ${AUTH_RATE_LIMIT_LOCKOUT_MINUTES:15}

  # Configuración de caché
  cache:
    entities:
      max-size: 1000
      expire-after-write: 10m
    lists:
      max-size: 100
      expire-after-write: 5m
    counts:
      max-size: 50
      expire-after-write: 2m

  # Configuración de rate limiting
  rate-limit:
    max-requests: 100
    window-seconds: 60

# Configuración de Springdoc OpenAPI
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    display-request-duration: true

# Configuración de logging (niveles específicos se definen por perfil)
logging:
  level:
    root: INFO
    org.springframework.security: INFO
    org.hibernate.SQL: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 100
        minimumNumberOfCalls: 10
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        # slowCallRateThreshold: % de llamadas lentas para abrir circuito
        # 100 = deshabilitado, 80 = abre si >80% de llamadas son lentas
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 2s
        recordExceptions:
          - java.lang.Exception
        ignoreExceptions:
          - java.lang.IllegalArgumentException
    instances:
      external:
        baseConfig: default
        waitDurationInOpenState: 30s
      database:
        baseConfig: default
        failureRateThreshold: 25

  ratelimiter:
    configs:
      default:
        registerHealthIndicator: true
        limitForPeriod: 100
        limitRefreshPeriod: 1s
        # timeoutDuration: 0 = fail-fast (rechaza inmediatamente si se excede el límite)
        # Valor > 0 = espera hasta ese tiempo antes de rechazar
        timeoutDuration: 0s
    instances:
      strict:
        limitForPeriod: 10
        limitRefreshPeriod: 1s
        timeoutDuration: 0s
      public-api:
        baseConfig: default

  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - java.lang.Exception
        ignoreExceptions:
          - java.lang.IllegalArgumentException
    instances:
      database:
        baseConfig: default
      external:
        maxAttempts: 2
        waitDuration: 1s

# Tracing Configuration (Micrometer Tracing + OpenTelemetry)
management:
  tracing:
    enabled: ${TRACING_ENABLED:true}
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:1.0}
  otlp:
    tracing:
      # El endpoint se define por perfil
      endpoint: ${OTLP_ENDPOINT:}
  observations:
    key-values:
      application: ${spring.application.name}
