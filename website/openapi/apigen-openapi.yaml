openapi: 3.1.0
info:
  title: APiGen REST API
  description: |
    APiGen provides a production-ready REST API for Spring Boot applications.

    ## Features
    - Full CRUD operations with HATEOAS support
    - Dynamic filtering with 12+ operators
    - Cursor and offset pagination
    - Soft delete with audit fields
    - ETag caching and conditional requests

    ## Authentication
    The API uses JWT Bearer tokens for authentication.
    Include the token in the `Authorization` header: `Bearer <token>`
  version: 1.0.0
  contact:
    name: APiGen Team
    url: https://github.com/jnzader/apigen
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: Products
    description: Product management operations
  - name: Authentication
    description: JWT authentication endpoints
  - name: Health
    description: Health check endpoints

paths:
  /api/products:
    get:
      tags:
        - Products
      summary: List all products
      description: |
        Returns a paginated list of products with optional filtering.

        **Filtering**: Use the `filter` query parameter with operators:
        - `eq` - Equal to
        - `neq` - Not equal to
        - `like` - Contains (case insensitive)
        - `gt`, `gte`, `lt`, `lte` - Comparison operators
        - `in` - In list
        - `between` - Range
        - `null`, `notnull` - Null checks

        Example: `?filter=category:eq:Electronics,price:lte:500`
      operationId: listProducts
      parameters:
        - name: page
          in: query
          description: Page number (0-indexed)
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction (e.g., name,asc)
          schema:
            type: string
        - name: filter
          in: query
          description: Filter expression (e.g., category:eq:Electronics)
          schema:
            type: string
        - name: fields
          in: query
          description: Sparse fieldsets - comma-separated field names
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          headers:
            X-Total-Count:
              description: Total number of items
              schema:
                type: integer
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductPageResponse'
        '400':
          description: Bad request - invalid filter syntax
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    post:
      tags:
        - Products
      summary: Create a new product
      description: Creates a new product and returns the created resource with HATEOAS links.
      operationId: createProduct
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductDTO'
      responses:
        '201':
          description: Product created successfully
          headers:
            Location:
              description: URL of the created resource
              schema:
                type: string
                format: uri
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '400':
          description: Validation error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ValidationProblemDetail'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    head:
      tags:
        - Products
      summary: Get total count
      description: Returns the total count of products in the X-Total-Count header.
      operationId: countProducts
      responses:
        '200':
          description: Count returned in header
          headers:
            X-Total-Count:
              description: Total number of items
              schema:
                type: integer

  /api/products/{id}:
    get:
      tags:
        - Products
      summary: Get product by ID
      description: Returns a single product with HATEOAS links and ETag for caching.
      operationId: getProduct
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: integer
            format: int64
        - name: If-None-Match
          in: header
          description: ETag value for conditional request
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          headers:
            ETag:
              description: Entity tag for caching
              schema:
                type: string
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '304':
          description: Not Modified - resource unchanged
        '404':
          description: Product not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    put:
      tags:
        - Products
      summary: Update product
      description: Full update of a product. Requires If-Match header for optimistic locking.
      operationId: updateProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: If-Match
          in: header
          required: true
          description: ETag value for optimistic locking
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductDTO'
      responses:
        '200':
          description: Product updated successfully
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: Product not found
        '412':
          description: Precondition Failed - ETag mismatch
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetail'

    patch:
      tags:
        - Products
      summary: Partial update product
      description: Partial update of a product fields.
      operationId: patchProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Product updated successfully
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: Product not found

    delete:
      tags:
        - Products
      summary: Delete product
      description: |
        Soft deletes the product by default.
        Use `permanent=true` for hard delete.
      operationId: deleteProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: permanent
          in: query
          description: If true, permanently deletes the resource
          schema:
            type: boolean
            default: false
      responses:
        '204':
          description: Product deleted successfully
        '404':
          description: Product not found

    head:
      tags:
        - Products
      summary: Check if product exists
      description: Returns 200 if product exists, 404 otherwise.
      operationId: productExists
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Product exists
        '404':
          description: Product not found

  /api/products/{id}/restore:
    post:
      tags:
        - Products
      summary: Restore deleted product
      description: Restores a soft-deleted product.
      operationId: restoreProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Product restored successfully
          content:
            application/hal+json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: Product not found

  /api/products/cursor:
    get:
      tags:
        - Products
      summary: Cursor-based pagination
      description: |
        More efficient pagination for large datasets.
        Uses keyset pagination instead of offset.
      operationId: listProductsCursor
      parameters:
        - name: cursor
          in: query
          description: Cursor token from previous response
          schema:
            type: string
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            default: 20
        - name: sort
          in: query
          description: Sort field
          schema:
            type: string
            default: id
        - name: direction
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [ASC, DESC]
            default: DESC
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CursorPage'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate with username and password to receive JWT tokens.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh token
      description: Exchange a refresh token for new access and refresh tokens.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid refresh token

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout
      description: Invalidate the current tokens.
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Logout successful

  /actuator/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the application.
      operationId: health
      responses:
        '200':
          description: Application is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

  schemas:
    ProductDTO:
      type: object
      required:
        - name
        - price
      properties:
        id:
          type: integer
          format: int64
          readOnly: true
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: "Laptop Pro"
        description:
          type: string
          maxLength: 1000
          example: "High-performance laptop"
        price:
          type: number
          format: decimal
          minimum: 0.01
          example: 999.99
        stock:
          type: integer
          minimum: 0
          default: 0
          example: 50
        category:
          type: string
          example: "Electronics"
        active:
          type: boolean
          readOnly: true
        createdAt:
          type: string
          format: date-time
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          readOnly: true
        createdBy:
          type: string
          readOnly: true
        modifiedBy:
          type: string
          readOnly: true

    ProductResponse:
      allOf:
        - $ref: '#/components/schemas/ProductDTO'
        - type: object
          properties:
            _links:
              $ref: '#/components/schemas/Links'

    ProductPageResponse:
      type: object
      properties:
        _embedded:
          type: object
          properties:
            products:
              type: array
              items:
                $ref: '#/components/schemas/ProductResponse'
        _links:
          $ref: '#/components/schemas/PageLinks'
        page:
          $ref: '#/components/schemas/PageMetadata'

    CursorPage:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/ProductDTO'
        cursor:
          type: string
          description: Cursor for next page
          example: "eyJpZCI6MTAwfQ=="
        hasNext:
          type: boolean
        hasPrevious:
          type: boolean
        size:
          type: integer

    Links:
      type: object
      properties:
        self:
          $ref: '#/components/schemas/Link'
        collection:
          $ref: '#/components/schemas/Link'
        update:
          $ref: '#/components/schemas/Link'
        delete:
          $ref: '#/components/schemas/Link'

    PageLinks:
      type: object
      properties:
        first:
          $ref: '#/components/schemas/Link'
        prev:
          $ref: '#/components/schemas/Link'
        self:
          $ref: '#/components/schemas/Link'
        next:
          $ref: '#/components/schemas/Link'
        last:
          $ref: '#/components/schemas/Link'

    Link:
      type: object
      properties:
        href:
          type: string
          format: uri

    PageMetadata:
      type: object
      properties:
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
        number:
          type: integer

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "admin"
        password:
          type: string
          format: password
          example: "password123"

    RefreshRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    TokenResponse:
      type: object
      properties:
        accessToken:
          type: string
          description: JWT access token
        refreshToken:
          type: string
          description: JWT refresh token
        tokenType:
          type: string
          default: "Bearer"
        expiresIn:
          type: integer
          description: Token expiration in seconds

    ProblemDetail:
      type: object
      description: RFC 7807 Problem Details
      properties:
        type:
          type: string
          format: uri
          example: "https://api.example.com/problems/not-found"
        title:
          type: string
          example: "Resource Not Found"
        status:
          type: integer
          example: 404
        detail:
          type: string
          example: "The requested resource could not be found"
        instance:
          type: string
          format: uri
          example: "/api/products/999"

    ValidationProblemDetail:
      allOf:
        - $ref: '#/components/schemas/ProblemDetail'
        - type: object
          properties:
            errors:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string
                  rejectedValue:
                    type: string

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [UP, DOWN]
        components:
          type: object
          additionalProperties:
            type: object
            properties:
              status:
                type: string
