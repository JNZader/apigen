# ==========================================
# APiGen - GraalVM Native Build
# ==========================================
# Builds native images using GraalVM Native Image
#
# Features:
# - Builds native executables for Linux (amd64, arm64)
# - Optional macOS and Windows builds
# - Uploads native binaries as release assets
# ==========================================

name: Native Build

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to build native image for'
        required: true
        default: 'apigen-server'
        type: choice
        options:
          - apigen-server
          - all
  release:
    types: [published]

env:
  GRAALVM_VERSION: '25'
  JAVA_VERSION: '25'

jobs:
  # ==========================================
  # Native Build Matrix
  # ==========================================
  native-build:
    name: Native Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: linux-amd64
            extension: ''
          - os: ubuntu-24.04-arm
            artifact: linux-arm64
            extension: ''
          # Uncomment for macOS/Windows builds (adds CI time)
          # - os: macos-latest
          #   artifact: macos-amd64
          #   extension: ''
          # - os: windows-latest
          #   artifact: windows-amd64
          #   extension: '.exe'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v2
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build native image
        run: |
          if [ "${{ github.event.inputs.module }}" == "all" ] || [ "${{ github.event_name }}" == "release" ]; then
            ./gradlew :apigen-server:nativeCompile --no-daemon
          else
            ./gradlew :${{ github.event.inputs.module }}:nativeCompile --no-daemon
          fi
        shell: bash

      - name: Prepare artifact
        run: |
          mkdir -p native-artifacts
          if [ -f apigen-server/build/native/nativeCompile/apigen-server${{ matrix.extension }} ]; then
            cp apigen-server/build/native/nativeCompile/apigen-server${{ matrix.extension }} \
               native-artifacts/apigen-server-${{ matrix.artifact }}${{ matrix.extension }}
          fi
        shell: bash

      - name: Upload native binary
        uses: actions/upload-artifact@v6
        with:
          name: apigen-native-${{ matrix.artifact }}
          path: native-artifacts/
          retention-days: 7

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: native-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # Native Docker Image
  # ==========================================
  native-docker:
    name: Native Docker Image
    runs-on: ubuntu-latest
    needs: native-build
    timeout-minutes: 20
    if: github.event_name == 'release'

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download native binary
        uses: actions/download-artifact@v4
        with:
          name: apigen-native-linux-amd64
          path: native-artifacts/

      - name: Set image name (lowercase)
        run: echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push native Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.native
          push: true
          tags: |
            ghcr.io/${{ env.IMAGE_NAME }}:${{ github.event.release.tag_name }}-native
            ghcr.io/${{ env.IMAGE_NAME }}:native
          labels: |
            org.opencontainers.image.title=APiGen Native
            org.opencontainers.image.description=APiGen compiled with GraalVM Native Image
