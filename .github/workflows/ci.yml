# ==========================================
# APiGen - CI Pipeline (Granular Multi-Module)
# ==========================================
# Granular build and test pipeline for APiGen library modules.
# Each module has its own test job for easy error identification.
#
# Jobs:
# - build: Compile all modules (fast feedback on compilation errors)
# - test-*: Individual test jobs per module (parallel execution)
# - code-quality: Architecture tests
# - security: Vulnerability scanning
# ==========================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '25'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

jobs:
  # ============================================
  # Build - Compile all modules
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile all modules
        run: ./gradlew classes testClasses --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-classes
          path: |
            */build/classes
            */build/resources
          retention-days: 1

  # ============================================
  # Test Jobs - One per module (parallel)
  # ============================================

  test-core:
    name: Test apigen-core
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-core tests
        run: ./gradlew :apigen-core:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-core
          path: |
            apigen-core/build/reports/tests/
            apigen-core/build/test-results/
          retention-days: 1

  test-security:
    name: Test apigen-security
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-security tests
        run: ./gradlew :apigen-security:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-security
          path: |
            apigen-security/build/reports/tests/
            apigen-security/build/test-results/
          retention-days: 1

  test-codegen:
    name: Test apigen-codegen
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-codegen tests
        run: ./gradlew :apigen-codegen:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-codegen
          path: |
            apigen-codegen/build/reports/tests/
            apigen-codegen/build/test-results/
          retention-days: 1

  test-server:
    name: Test apigen-server
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: apigen_test
          POSTGRES_USER: apigen_user
          POSTGRES_PASSWORD: apigen_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-server tests
        run: ./gradlew :apigen-server:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_URL: jdbc:postgresql://localhost:5432/apigen_test
          DB_USERNAME: apigen_user
          DB_PASSWORD: apigen_password


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-server
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-gateway:
    name: Test apigen-gateway
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-gateway tests
        run: ./gradlew :apigen-gateway:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-gateway
          path: |
            apigen-gateway/build/reports/tests/
            apigen-gateway/build/test-results/
          retention-days: 1

  test-graphql:
    name: Test apigen-graphql
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-graphql tests
        run: ./gradlew :apigen-graphql:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-graphql
          path: |
            apigen-graphql/build/reports/tests/
            apigen-graphql/build/test-results/
          retention-days: 1

  test-grpc:
    name: Test apigen-grpc
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-grpc tests
        run: ./gradlew :apigen-grpc:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-grpc
          path: |
            apigen-grpc/build/reports/tests/
            apigen-grpc/build/test-results/
          retention-days: 1

  # ============================================
  # Integration Tests - Generated Project Compilation (per language)
  # ============================================

  test-generated-java:
    name: Test Generated Java Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run generated project annotation tests
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedApplicationShouldHaveJpaAnnotationsWithSecurity" --tests "GeneratedProjectCompilationIT.generatedApplicationShouldHaveSimpleJpaAnnotationsWithoutSecurity" --tests "GeneratedProjectCompilationIT.generatedProjectShouldIncludeContextTest" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: Run Java generated project context test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedProjectWithSecurityShouldPassContextTest" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-generated-java
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-kotlin:
    name: Test Generated Kotlin Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Kotlin generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedKotlinProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-generated-kotlin
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-csharp:
    name: Test Generated C# Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run C# generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedCSharpProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-generated-csharp
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-python:
    name: Test Generated Python Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Python generated project syntax test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedPythonProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-python
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-php:
    name: Test Generated PHP Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run PHP generated project syntax test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedPhpProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-php
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-typescript:
    name: Test Generated TypeScript Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run TypeScript generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedTypeScriptProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-typescript
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-go:
    name: Test Generated Go Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Go generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedGoProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-go
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-go-chi:
    name: Test Generated Go/Chi Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Go/Chi generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedGoChiProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-go-chi
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-generated-rust-axum:
    name: Test Generated Rust/Axum Project
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Rust/Axum generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedRustAxumProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-rust-axum
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  # ============================================
  # Summary Job - Aggregates all results
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - test-core
      - test-security
      - test-codegen
      - test-server
      - test-gateway
      - test-graphql
      - test-grpc
      - test-generated-java
      - test-generated-kotlin
      - test-generated-csharp
      - test-generated-python
      - test-generated-php
      - test-generated-typescript
      - test-generated-go
      - test-generated-go-chi
      - test-generated-rust-axum
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: all-test-results
          merge-multiple: false

      - name: Generate summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Module Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-core | ${{ needs.test-core.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-security | ${{ needs.test-security.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-codegen | ${{ needs.test-codegen.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-server | ${{ needs.test-server.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-gateway | ${{ needs.test-gateway.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-graphql | ${{ needs.test-graphql.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-grpc | ${{ needs.test-grpc.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Project Compilation Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Java/Spring Boot | ${{ needs.test-generated-java.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kotlin/Spring Boot | ${{ needs.test-generated-kotlin.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| C#/ASP.NET Core | ${{ needs.test-generated-csharp.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python/FastAPI | ${{ needs.test-generated-python.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PHP/Laravel | ${{ needs.test-generated-php.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript/NestJS | ${{ needs.test-generated-typescript.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go/Gin | ${{ needs.test-generated-go.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Go/Chi | ${{ needs.test-generated-go-chi.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust/Axum | ${{ needs.test-generated-rust-axum.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Code Quality
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check code formatting
        run: ./gradlew spotlessCheck --no-daemon
        
      - name: Run architecture tests
        run: ./gradlew :apigen-core:test --tests "*ArchitectureTest*" --no-daemon
        
  # ============================================
  # Security Scan
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Build Libraries (for release)
  # ============================================
  package:
    name: Package Libraries
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - test-core
      - test-security
      - test-codegen
      - test-server
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JARs
        run: ./gradlew jar --no-daemon

      - name: Upload library artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apigen-libraries
          path: |
            apigen-core/build/libs/*.jar
            apigen-security/build/libs/*.jar
            apigen-codegen/build/libs/*.jar
            apigen-server/build/libs/*.jar
          retention-days: 7
