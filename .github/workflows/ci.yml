# ==========================================
# APiGen - CI Pipeline (Granular Multi-Module)
# ==========================================
# Granular build and test pipeline for APiGen library modules.
# Each module has its own test job for easy error identification.
#
# Jobs:
# - build: Compile all modules (fast feedback on compilation errors)
# - test-*: Individual test jobs per module (parallel execution)
# - code-quality: Architecture tests
# - security: Vulnerability scanning
# ==========================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  JAVA_VERSION: '25'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

jobs:
  # ============================================
  # Build - Compile all modules
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile all modules
        run: ./gradlew classes testClasses --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: build-classes
          path: |
            */build/classes
            */build/resources
          retention-days: 1

  # ============================================
  # Test Jobs - One per module (parallel)
  # ============================================

  test-core:
    name: Test apigen-core
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-core tests
        run: ./gradlew :apigen-core:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-core
          path: |
            apigen-core/build/reports/tests/
            apigen-core/build/test-results/
          retention-days: 1

  test-security:
    name: Test apigen-security
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-security tests
        run: ./gradlew :apigen-security:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-security
          path: |
            apigen-security/build/reports/tests/
            apigen-security/build/test-results/
          retention-days: 1

  test-codegen:
    name: Test apigen-codegen
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-codegen tests
        run: ./gradlew :apigen-codegen:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-codegen
          path: |
            apigen-codegen/build/reports/tests/
            apigen-codegen/build/test-results/
          retention-days: 1

  test-server:
    name: Test apigen-server
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: apigen_test
          POSTGRES_USER: apigen_user
          POSTGRES_PASSWORD: apigen_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-server tests
        run: ./gradlew :apigen-server:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_URL: jdbc:postgresql://localhost:5432/apigen_test
          DB_USERNAME: apigen_user
          DB_PASSWORD: apigen_password


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-server
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  test-gateway:
    name: Test apigen-gateway
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-gateway tests
        run: ./gradlew :apigen-gateway:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-gateway
          path: |
            apigen-gateway/build/reports/tests/
            apigen-gateway/build/test-results/
          retention-days: 1

  test-graphql:
    name: Test apigen-graphql
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-graphql tests
        run: ./gradlew :apigen-graphql:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-graphql
          path: |
            apigen-graphql/build/reports/tests/
            apigen-graphql/build/test-results/
          retention-days: 1

  test-grpc:
    name: Test apigen-grpc
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run apigen-grpc tests
        run: ./gradlew :apigen-grpc:test --no-daemon --continue
        env:
          SPRING_PROFILES_ACTIVE: test


      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-grpc
          path: |
            apigen-grpc/build/reports/tests/
            apigen-grpc/build/test-results/
          retention-days: 1

  # ============================================
  # Integration Test - Generated Project Compilation
  # ============================================
  test-generated-project:
    name: Test Generated Project
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run generated project annotation tests
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: Run Java generated project context test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedProjectWithSecurityShouldPassContextTest" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Run Kotlin generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedKotlinProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Run C# generated project compilation test
        run: ./gradlew :apigen-server:test --tests "GeneratedProjectCompilationIT.generatedCSharpProjectShouldCompile" --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          CI_COMPILE_GENERATED_PROJECT: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: test-results-generated-project
          path: |
            apigen-server/build/reports/tests/
            apigen-server/build/test-results/
          retention-days: 1

  # ============================================
  # Summary Job - Aggregates all results
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-core
      - test-security
      - test-codegen
      - test-server
      - test-gateway
      - test-graphql
      - test-grpc
      - test-generated-project
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: all-test-results
          merge-multiple: false

      - name: Generate summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-core | ${{ needs.test-core.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-security | ${{ needs.test-security.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-codegen | ${{ needs.test-codegen.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-server | ${{ needs.test-server.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-gateway | ${{ needs.test-gateway.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-graphql | ${{ needs.test-graphql.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| apigen-grpc | ${{ needs.test-grpc.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| generated-project | ${{ needs.test-generated-project.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Code Quality
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check code formatting
        run: ./gradlew spotlessCheck --no-daemon
        continue-on-error: true

      - name: Run architecture tests
        run: ./gradlew test --tests "*ArchitectureTest*" --no-daemon
        continue-on-error: true

  # ============================================
  # Security Scan
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Build Libraries (for release)
  # ============================================
  package:
    name: Package Libraries
    runs-on: ubuntu-latest
    needs:
      - test-core
      - test-security
      - test-codegen
      - test-server
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build JARs
        run: ./gradlew jar --no-daemon

      - name: Upload library artifacts
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: apigen-libraries
          path: |
            apigen-core/build/libs/*.jar
            apigen-security/build/libs/*.jar
            apigen-codegen/build/libs/*.jar
            apigen-server/build/libs/*.jar
          retention-days: 7
