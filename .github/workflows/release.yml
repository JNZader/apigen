# ==========================================
# APiGen - Semantic Release
# ==========================================
# Automatic versioning and release based on conventional commits
#
# Features:
# - Analyzes commits since last release
# - Determines version bump (major/minor/patch)
# - Updates CHANGELOG.md
# - Creates GitHub release with assets
# - Publishes to Maven Central (optional)
# ==========================================

name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/release.yml'

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

env:
  JAVA_VERSION: '25'

jobs:
  # ==========================================
  # Semantic Release
  # ==========================================
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on main branch pushes (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build project
        run: ./gradlew build -x test --no-daemon

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install semantic-release
        run: |
          npm install -g semantic-release \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/exec \
            @semantic-release/git \
            @semantic-release/github \
            conventional-changelog-conventionalcommits

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            npx semantic-release --dry-run
          else
            npx semantic-release
          fi

  # ==========================================
  # Publish to Maven Central (optional)
  # ==========================================
  publish:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    needs: release
    timeout-minutes: 20
    if: needs.release.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main  # Get the updated version
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Publish to Maven Central
        run: |
          echo "Maven Central publishing placeholder"
          echo "To enable, configure these secrets:"
          echo "- OSSRH_USERNAME"
          echo "- OSSRH_PASSWORD"
          echo "- GPG_PRIVATE_KEY"
          echo "- GPG_PASSPHRASE"
          # ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository --no-daemon
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          SIGNING_PASSWORD: ${{ secrets.GPG_PASSPHRASE }}
